version: v1.0
name: Performous web build
agent:
  machine:
    type: e1-standard-2
    os_image: ubuntu2004
execution_time_limit:
  minutes: 30
blocks:
  - name: Ubuntu 20.04 Build
    execution_time_limit:
      minutes: 15
    dependencies: []
    task:
      secrets:
        - name: git-deploy-token
      prologue:
        commands:
          - echo "Preparing repository"
          - checkout
          - git submodule update --init --recursive
          - echo "Preparing environment to be able to use git..."
          - ssh-keyscan -H github.com >> ~/.ssh/known_hosts
          - chmod 600 ~/.ssh/id_rsa_git_deploy
          - ssh-add ~/.ssh/id_rsa_git_deploy
          - echo "Compiling webconv so we can still dynamicly make our website."
          - g++ webconv/webconv.cpp -o webconv/webconv
      jobs:
        - name: Webconv Build
          commands:
            - |
              if [ -d ./web ]; then
                  rm -Rfv ./web
              fi
            - git clone --depth=50 --branch=gh-pages git@github.com:performous/web.git
            - ./webconv/webconv ./htdocs-source ./web
            - |
              if [[ $SEMAPHORE_GIT_BRANCH != "master" ]]; then
                  echo "stop execution here since we're not on the master branch."
              else
                  cp -rp ./htdocs-binary/* ./web
                  cd ./web
                  git config user.email 'nobody@performous.org'
                  git config user.name 'Performous Website Bot'
                  git config push.default simple
                  git add -A
                  git commit -am "Update website from commit $SEMAPHORE_GIT_SHA"
                  git push -u HEAD:gh-pages
                  echo "Visit https://performous.org for the update of the website."
              fi